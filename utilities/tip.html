<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>Tip Calculator | No Spin Utilities</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    #site-header { position: relative; z-index: 2000; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #222; padding-top: 70px; }
    .container { display: flex; flex-wrap: wrap; padding: 2rem; max-width: 1200px; margin: 0 auto; gap: 2rem; }
    .main { flex: 1 1 60%; background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
    .sidebar { flex: 1 1 30%; background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-self: flex-start; }
    h1 { font-size: 2rem; margin-top: 0; }
    .input-row { display: flex; gap: 0.5rem; }
    .input-col { flex: 1; }
    label { font-weight: bold; margin-top: 0.6rem; display: block; }
    input[type="number"], input[type="email"] { width: 100%; padding: 6px; margin-top: 4px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.8rem; }
    .checkbox-grid label { font-weight: normal; display: flex; align-items: center; }
    .button-row { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .button-row button { flex: 1; }
    button { background: #0073e6; color: #fff; border: none; padding: 10px; font-weight: bold; border-radius: 4px; cursor: pointer; }
    button:hover { background: #005bb5; }
    .adjust-buttons { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .adjust-buttons button { flex: 1; padding: 6px; font-size: 0.9rem; }
    .clear-btn { background: #d9534f; }
    .clear-btn:hover { background: #b52b27; }
    .result { margin-top: 1rem; font-size: 1.1rem; background: #f9f9f9; padding: 0.8rem; border-radius: 6px; border: 1px solid #ddd; }
    #tagline { margin-top: 0.5rem; text-align: center; font-size: 0.9rem; color: #555; }
    #emailStatus { margin-top: 6px; color: green; font-weight: bold; font-size: 0.9rem; }
    #version { position: absolute; bottom: 6px; right: 8px; font-size: 0.8rem; color: #999; }
    footer { text-align: center; margin-top: 2rem; color: #555; font-size: 0.9rem; }
    .share-buttons { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .share-buttons button { flex: 1; background: #0073e6; color: #fff; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .share-buttons button:hover { background: #005bb5; }
    @media (max-width: 768px) { .container { flex-direction: column; } .button-row { flex-direction: column; } .adjust-buttons { flex-direction: column; } }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <div class="container">
    <div class="main">
      <h1>üí∞ Tip Calculator</h1>
      <p>Quickly calculate tips with rounding options, manual overrides, and optional email receipts.</p>

      <div class="input-row">
        <div class="input-col">
          <label>Bill Total:</label>
          <input type="number" step="0.01" inputmode="decimal" id="billTotal" placeholder="Enter total + Tax">
        </div>
        <div class="input-col">
          <label>Tax Total:</label>
          <input type="number" step="0.01" inputmode="decimal" id="taxTotal" placeholder="Optional">
        </div>
      </div>

      <div class="input-row">
        <div class="input-col">
          <label>Tip %:</label>
          <input type="number" step="0.01" inputmode="decimal" id="tipPercent" value="20">
        </div>
        <div class="input-col">
          <label>Manual Tip:</label>
          <input type="number" step="0.01" inputmode="decimal" id="manualTip" placeholder="Optional">
        </div>
      </div>

      <div class="checkbox-grid">
        <label><input type="checkbox" id="roundUp"> Round Up</label>
        <label><input type="checkbox" id="roundDown"> Round Down</label>
        <label><input type="checkbox" id="exactPercent"> Exact %</label>
        <label><input type="checkbox" id="excludeTax"> Exclude Tax</label>
      </div>

      <label>Your Email:</label>
      <input type="email" id="userEmail" placeholder="Enter email to receive receipt">

      <div class="button-row">
        <button onclick="calculateTip(true)">Calculate Tip</button>
        <button onclick="completeTip()">‚úÖ Complete & Email</button>
      </div>

      <div class="adjust-buttons">
        <button onclick="adjustTotal(0.5)">+ $0.50</button>
        <button onclick="adjustTotal(-0.5)">- $0.50</button>
        <button class="clear-btn" onclick="clearFields()">Clear</button>
        <button onclick="window.location.href='install-tip.html'">‚ùì Help & Install</button>
        <button onclick="openFilePicker()">üìé Attach File</button>
      </div>

      <input
        type="file"
        id="attachmentInput"
        style="display:none"
        accept="image/*,application/pdf,text/plain,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      />

      <div class="result" id="result"></div>

      <div class="share-buttons">
        <button onclick="copyLink()">Copy Link</button>
        <button onclick="sharePage()">Share with Friends</button>
      </div>

      <div id="emailStatus"></div>
      <div id="tagline"></div>
      <div id="version">v4.7</div>
    </div>

    <div class="sidebar">
      <h2>Support Our Utilities üíô</h2>
      <p>Like these tools? Help keep No Spin Utilities running:</p>
      <p><strong>Venmo:</strong><br/><a href="https://venmo.com/NoSpinMedia" target="_blank">@NoSpinMedia</a></p>
      <h2>Follow Us</h2>
      <p>üìò <a href="https://facebook.com/NoSpinNewsAI" target="_blank">facebook.com/NoSpinNewsAI</a></p>
      <h2>We‚ù§Ô∏è Your Feedback!</h2>
      <p>Have an idea for improving this tool? We read every suggestion. üòä</p>
      <p>You can also reach us at: <strong>nospinmedia.ai@gmail.com</strong></p>
      <form id="feedbackForm">
        <input type="text" id="name" name="name" placeholder="Your first name">
        <input type="email" id="email" name="email" placeholder="you@email.com" required>
        <textarea id="message" name="message" rows="4" placeholder="Your feedback..." required></textarea>
        <p id="formStatus"></p>
        <button type="submit">üí¨ Send Feedback</button>
      </form>
    </div>
  </div>

  <p style="font-size: 0.8rem; color: #888; text-align: center; max-width: 800px; margin: 2rem auto 0;">
    üîí <strong>We respect your privacy.</strong> This site does not use cookies, tracking technologies, or collect personal data.
  </p>

  <footer>¬© 2025 No Spin Media. Independent. Truth-focused.<br>Seriously factual, surprisingly fun.</footer>

  <script>
    // ==== Config / globals ====
    const MAX_FILE_BYTES = 7 * 1024 * 1024; // 7 MB cap
    let _attachment = null;                 // { filename, mimeType, base64 } or null
    let POST_ADJUST = false;                // after +/- nudges, ignore rounding until next Calculate

    // ==== Header loader (unchanged) ====
document.addEventListener('DOMContentLoaded', function() {
fetch('../header.html')
  .then(res => res.text())
  .then(html => {
    const host = document.getElementById('site-header');
    host.innerHTML = html;

    // Try a broad set of common selectors, including your originals
    const toggle = host.querySelector(
      '[data-menu-toggle], #menu-toggle, .menu-toggle, .hamburger, .hamburger-btn, #hamburger'
    );
    const menu = host.querySelector(
      '[data-menu], #mobile-menu, #nav-menu, .mobile-menu, #mobile-nav'
    );

    // Helpful diagnostics while we‚Äôre fixing this
    console.log('Header toggle found?', !!toggle);
    console.log('Header menu found?', !!menu);

    if (toggle && menu) {
      if (!menu.hasAttribute('hidden') && getComputedStyle(menu).display !== 'none') {
        menu.setAttribute('hidden', '');
      }

      const toggleMenu = (e) => {
        e.preventDefault();
        const isHidden = menu.hasAttribute('hidden');
        if (isHidden) { menu.removeAttribute('hidden'); menu.classList.add('open'); }
        else { menu.setAttribute('hidden', ''); menu.classList.remove('open'); }
        toggle.setAttribute('aria-expanded', String(isHidden));
      };

      // Bind once, guard against double-binding
      if (!toggle.dataset.bound) {
        toggle.addEventListener('click', toggleMenu);
        toggle.addEventListener('touchstart', toggleMenu, { passive: false });
        toggle.dataset.bound = '1';
      }

      // Close menu when a link is tapped
      menu.addEventListener('click', (ev) => {
        if (!ev.target.closest('a')) return;
        menu.setAttribute('hidden','');
        menu.classList.remove('open');
        toggle.setAttribute('aria-expanded','false');
      });
    } else {
      console.warn('Header menu elements not found on this page.');
    }
  });

      // Prefill & restore choices
      const savedEmail = localStorage.getItem('userEmail');
      if (savedEmail) document.getElementById('userEmail').value = savedEmail;
      document.getElementById('tipPercent').value = localStorage.getItem('tipPercent') || 20;

      ['roundUp','roundDown','exactPercent','excludeTax'].forEach(id => {
        if (localStorage.getItem(id) === 'true') document.getElementById(id).checked = true;
      });

      // Enforce exclusivity among Exact% / Round Up / Round Down
      document.querySelectorAll('#roundUp,#roundDown,#exactPercent').forEach(cb => {
        cb.addEventListener('change', e => {
          if (e.target.checked) {
            ['roundUp','roundDown','exactPercent'].forEach(id => {
              if (id !== e.target.id) document.getElementById(id).checked = false;
            });
          }
        });
      });

      // File input
      document.getElementById('attachmentInput').addEventListener('change', handleFileChange);

      // Feedback form (unchanged endpoint)
      document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const status = document.getElementById('formStatus');
        status.textContent = "‚è≥ Sending...";
        const data = {
          name: document.getElementById('name').value || "Someone",
          email: document.getElementById('email').value,
          subject: "Tip Utility Feedback",
          message: document.getElementById('message').value
        };
        try {
          const res = await fetch('https://script.google.com/macros/s/AKfycbwr26uY61Dip94_QwzyLh1JDSIFdYHJgqL_scKGLdRd9O42VLDBvt2XzkA67tjphJrs/exec', {
            method: 'POST',
            headers: {'Content-Type':'text/plain'},
            body: JSON.stringify(data)
          });
          try { await res.json(); } catch {}
          status.textContent = "‚úÖ Thanks! Your feedback was sent."; this.reset();
          setTimeout(()=>{ status.textContent=""; }, 4000);
        } catch(err) {
          status.textContent = "‚ùå Failed to send!";
        }
      });
    });

    // ==== Core math ====
    function calculateValues() {
      const total = parseFloat(document.getElementById('billTotal').value) || 0;
      const taxInput = document.getElementById('taxTotal').value.trim();
      const tax = (taxInput === "") ? null : (parseFloat(taxInput) || 0);
      const percent = parseFloat(document.getElementById('tipPercent').value) || 20;
      const manualTip = parseFloat(document.getElementById('manualTip').value);
      const excludeTax = document.getElementById('excludeTax').checked;

      // Base = pre-tax when Exclude Tax is on and a tax value exists
      const base = (excludeTax && tax !== null) ? total - tax : total;

      let tip = !isNaN(manualTip) ? manualTip : base * (percent / 100);
      let finalTotal = total + tip;

      // Apply rounding only when not in post-adjust mode
      const useRounding =
        !POST_ADJUST &&
        (document.getElementById('roundUp').checked || document.getElementById('roundDown').checked);

      if (useRounding) {
        if (document.getElementById('roundUp').checked) {
          finalTotal = Math.ceil(finalTotal);
          tip = finalTotal - total;
        }
        if (document.getElementById('roundDown').checked) {
          finalTotal = Math.floor(finalTotal);
          tip = finalTotal - total;
        }
      }

      const simplePercent = Math.round((tip / base) * 100);
      const exactPercent = (tip / base) * 100;

      // Persist preferences
      localStorage.setItem('userEmail', document.getElementById('userEmail').value.trim());
      localStorage.setItem('tipPercent', percent);
      ['roundUp','roundDown','exactPercent','excludeTax'].forEach(id=>{
        localStorage.setItem(id, document.getElementById(id).checked);
      });

      return { total, tax, base, tip, finalTotal, simplePercent, exactPercent };
    }

    function calculateTip(reset = false) {
      if (reset) {
        POST_ADJUST = false;                              // return to rounding behavior
        document.getElementById('manualTip').value = '';  // back to % mode
      }

      const { total, tax, base, tip, finalTotal, exactPercent } = calculateValues();
      if (total <= 0) {
        document.getElementById('result').innerHTML = "‚ùå Enter a Bill Total to calculate.";
        return;
      }

      let msg = '';
      const mealCost = (tax !== null && tax <= total) ? total - tax : total;

      if (tax !== null) {
        msg += `Meal Cost (Pre-Tax): $${mealCost.toFixed(2)}<br>`;
        const taxPct = (tax / mealCost) * 100;
        msg += `Tax: $${tax.toFixed(2)} (${taxPct.toFixed(2)}%)<br>`;
      }
      msg += `Bill Total: $${total.toFixed(2)}<br>`;

      const manualTip = parseFloat(document.getElementById('manualTip').value);
      const tipLabel = !isNaN(manualTip) ? "Manual Tip Entered" : `${document.getElementById('tipPercent').value}% preferred`;
      msg += `Tip: $${tip.toFixed(2)} (${tipLabel}, ${exactPercent.toFixed(2)}% actual)<br><br>`;
      msg += `<strong>Total with Tip: $${finalTotal.toFixed(2)}</strong>`;

      document.getElementById('result').innerHTML = msg;
      document.getElementById('emailStatus').textContent = "";
      showTagline();
    }

    // Adjust final total by +/- amount, update manual tip, and ignore rounding until next Calculate
    function adjustTotal(amount) {
      const vals = calculateValues();
      if (vals.total <= 0) {
        document.getElementById('result').innerHTML = "‚ùå Enter a Bill Total first.";
        return;
      }
      POST_ADJUST = true;
      const newFinal = Math.max(0, vals.finalTotal + amount);
      const newTip = Math.max(0, newFinal - vals.total);
      document.getElementById('manualTip').value = newTip.toFixed(2);
      calculateTip(false);
    }

    function clearFields() {
      POST_ADJUST = false;
      document.getElementById('billTotal').value='';
      document.getElementById('taxTotal').value='';
      document.getElementById('manualTip').value='';
      document.getElementById('result').innerHTML='';
      document.getElementById('emailStatus').textContent='';
      document.getElementById('tagline').textContent='';
      _attachment = null;
    }

    function getRandomTagline(){
      const tags=[
        "Thank you for using No Spin Utilities!",
        "If you enjoyed this, share it with friends!",
        "Your support keeps our tools free & fun!",
        "Check out our other utilities at No Spin Media!",
        "Made with ‚ù§Ô∏è for honest, simple tools."
      ];
      return tags[Math.floor(Math.random()*tags.length)] + "\n\nCheck out our other utilities:\nhttps://nospin.media/utilities/index.html";
    }

    function showTagline(){ document.getElementById('tagline').textContent = getRandomTagline().split("\n")[0]; }

    // ==== Share helpers ====
    function copyLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert("‚úÖ Link copied to clipboard!");
      });
    }
    function sharePage() {
      if (navigator.share) {
        navigator.share({ title: "Tip Calculator", text: "Check out this Tip Calculator!", url: window.location.href });
      } else {
        copyLink();
      }
    }

    // ==== File attach ====
    function openFilePicker() { document.getElementById('attachmentInput').click(); }
    function handleFileChange(e) {
      const file = e.target.files && e.target.files[0];
      const status = document.getElementById('emailStatus');
      if (!file) { _attachment = null; return; }
      if (file.size > MAX_FILE_BYTES) {
        _attachment = null;
        status.style.color = 'red';
        status.textContent = `‚ùå File too large. Max ${(MAX_FILE_BYTES/1024/1024).toFixed(0)} MB.`;
        setTimeout(()=>{ status.textContent=''; status.style.color='green'; }, 4000);
        e.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        _attachment = { filename: file.name, mimeType: file.type || 'application/octet-stream', base64: reader.result };
        status.style.color = 'green';
        status.textContent = `üìé Attached: ${file.name}`;
        setTimeout(()=>{ status.textContent=''; }, 3000);
      };
      reader.onerror = () => {
        _attachment = null;
        status.style.color = 'red';
        status.textContent = '‚ùå Failed to read file.';
        setTimeout(()=>{ status.textContent=''; status.style.color='green'; }, 4000);
      };
      reader.readAsDataURL(file);
    }

    // ==== Email (unchanged endpoint) ====
    async function completeTip() {
      const { total, tax, base, tip, finalTotal, exactPercent } = calculateValues();
      if (total <= 0) {
        document.getElementById('result').innerHTML = "‚ùå Enter a Bill Total before sending.";
        return;
      }
      calculateTip(false); // keep current on-screen state

      const emailField = document.getElementById('userEmail');
      const email = emailField.value.trim();
      if (!email) {
        emailField.style.border = '2px solid red';
        document.getElementById('emailStatus').textContent = "‚ùå Enter your email to receive receipt.";
        return;
      } else {
        emailField.style.border = '';
      }

      let message = '';
      const mealCost = (tax !== null && tax <= total) ? total - tax : total;

      if (tax !== null) {
        const taxPct = (tax / mealCost) * 100;
        message += `Meal Cost (Pre-Tax): $${mealCost.toFixed(2)}\n`;
        message += `Tax: $${tax.toFixed(2)} (${taxPct.toFixed(2)}%)\n`;
      } else {
        message += `Meal Cost (Pre-Tax): $${mealCost.toFixed(2)}\n`;
      }

      const manualTip = parseFloat(document.getElementById('manualTip').value);
      const tipLabel = !isNaN(manualTip) ? "Manual Tip Entered" : `${document.getElementById('tipPercent').value}% preferred`;
      message += `Bill Total: $${total.toFixed(2)}\n`;
      message += `Tip: $${tip.toFixed(2)} (${tipLabel}, ${exactPercent.toFixed(2)}% actual)\n\n`;
      message += `Total with Tip: $${finalTotal.toFixed(2)}\n\n`;
      if (document.getElementById('excludeTax').checked) message += `(Tip calculated excluding tax)\n`;
      message += getRandomTagline();

      const payload = { name: "No Spin Utilities", email, subject: "Your Tip Calculator Receipt", message };

      if (_attachment) {
        const isImage = (_attachment.mimeType || "").startsWith("image/");
        if (isImage) {
          payload.imageBase64 = _attachment.base64;
          payload.filename = _attachment.filename;
          payload.mimeType = _attachment.mimeType;
        } else {
          payload.attachments = [_attachment];
          const status = document.getElementById('emailStatus');
          status.style.color = 'green';
          status.textContent = "‚ÑπÔ∏è Non-image file selected; sending. If it doesn't arrive, update server script.";
          setTimeout(()=>{ status.textContent=''; }, 4000);
        }
      }

      await fetch('https://script.google.com/macros/s/AKfycbwRMD0KhGcv8YGo-GFw2onU5PYldc19J50uGCqRuxbA2wSTj2y8uNZaBnp-DrbHr_rNjQ/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });

      const confirmText = _attachment ? `‚úÖ Receipt sent to ${email} (with attachment)` : `‚úÖ Receipt sent to ${email}`;
      const status = document.getElementById('emailStatus');
      status.style.color = 'green';
      status.textContent = confirmText;
    }
  </script>
</body>
</html>
