<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sudoku - No Spin Media</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* Global box-sizing for consistent layout */
    * {
      box-sizing: border-box;
    }

    /* Global body styles for the game theme - same as chess */
    body {
      background: #222831; /* Deep charcoal for a calm background */
      color: #fff;
      margin: 0;
      font-family: 'Inter', Arial, sans-serif; /* Using Inter for a modern look */
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Ensure footer stays at bottom */
    }

    /* Main game container layout - same as chess */
    #game-container {
      display: flex;
      justify-content: center;
      padding: 20px;
      gap: 30px;
      flex-wrap: wrap; /* Allows wrapping on smaller screens */
      flex-grow: 1; /* Allows container to grow and push footer down */
    }

    /* Game box styling (main game area) - same as chess */
    #game-box {
      border: 2px solid #74B9FF; /* Muted blue border */
      box-shadow: 0 0 20px #74B9FF; /* Muted blue glow */
      padding: 20px; /* Increased padding */
      border-radius: 12px; /* More rounded corners */
      background: #222831; /* Match body background */
      position: relative;
      flex-grow: 1;
      max-width: 550px; /* Adjusted max-width for desktop */
      width: 100%; /* Ensure it takes full width within max-width */
      min-width: 320px;
      display: flex;
      flex-direction: column;
    }

    /* Game header styling - same as chess */
    #game-header {
      color: #74B9FF;
      text-align: center;
      font-size: 2.2em;
      margin-bottom: 10px;
      text-shadow: 0 0 10px #74B9FF;
      position: relative;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(116, 185, 255, 0.3);
    }

    #game-version {
      position: absolute;
      top: 5px;
      right: 15px;
      color: #74B9FF;
      font-size: 0.7em;
      opacity: 0.7;
    }

    /* Game info (messages) - using for Sudoku messages */
    #game-info {
      text-align: center;
      color: #74B9FF;
      margin-bottom: 15px;
      font-weight: bold;
      font-size: 1.1em;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
    }
    #game-info span {
      padding: 5px 10px;
      background: rgba(116, 185, 255, 0.1);
      border-radius: 5px;
    }

    /* Game controls/buttons - same as chess */
    .game-controls {
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .game-controls button {
      padding: 10px 20px;
      margin: 0 5px;
      background: #60A3D9;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1em;
      box-shadow: 0 0 10px rgba(96, 163, 217, 0.5);
      transition: all 0.2s ease-in-out;
    }

    .game-controls button:hover {
      background: #7ABCEF;
      box-shadow: 0 0 15px rgba(122, 188, 239, 0.8);
      transform: translateY(-2px);
    }

    .game-controls button:active {
      transform: translateY(0);
      box-shadow: 0 0 5px rgba(96, 163, 217, 0.3);
    }

    .game-controls button.active-mode {
        background: #FFD700; /* Gold for active pencil mode */
        color: #000;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    }

    /* Difficulty dropdown */
    .game-controls select {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #60A3D9;
        background-color: #2E4057;
        color: #fff;
        font-size: 1.1em;
        cursor: pointer;
        outline: none;
        box-shadow: 0 0 10px rgba(96, 163, 217, 0.3);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .game-controls select:hover {
        border-color: #7ABCEF;
        box-shadow: 0 0 15px rgba(122, 188, 239, 0.5);
    }

    /* Sidebar styling (Donate section) - same as chess */
    #sidebar {
      background: #222831;
      border: 2px solid #74B9FF;
      box-shadow: 0 0 15px #74B9FF;
      padding: 20px;
      border-radius: 8px;
      max-width: 280px;
      height: fit-content;
      text-align: center;
      margin-top: 15px;
      flex-shrink: 0; /* Prevent sidebar from shrinking */
    }

    #sidebar h2 {
      color: #74B9FF;
      text-align: center;
      margin-bottom: 15px;
    }

    #donate-button {
      background: #ffd700;
      color: #000;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin: 15px auto 10px;
      display: block;
      transition: all 0.2s ease-in-out;
    }

    #donate-button:hover {
      background: #ffe033;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
      transform: translateY(-2px);
    }

    #donate-button:active {
      transform: translateY(0);
      box-shadow: 0 0 5px rgba(96, 163, 217, 0.3);
    }

    #sidebar p {
      font-size: 0.9em;
      color: #aaa;
      line-height: 1.4;
    }

    /* Footer styling - same as chess */
    footer {
      text-align: center;
      color: #666;
      padding: 15px;
      font-size: 0.9em;
      margin-top: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- Sudoku Board Specific Layout --- */
    #sudoku-board {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(9, 1fr);
      width: 100%; /* Make board take 100% of parent's width */
      aspect-ratio: 1 / 1; /* Keep it square */
      margin: 10px auto;
      border: 4px solid #74B9FF;
      box-shadow: 0 0 25px rgba(116, 185, 255, 0.5);
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      max-width: 500px; /* Max width for desktop board */
    }

    .sudoku-cell {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em; /* Adjusted font size for desktop */
      font-weight: bold;
      cursor: pointer;
      border: 1px solid #333;
      background-color: #AEC6CF;
      color: #000;
      transition: background-color 0.2s ease-in-out;
      position: relative; /* For pencil marks positioning */
    }

    /* Pencil marks grid inside cell */
    .sudoku-cell .pencil-marks {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        width: 100%;
        height: 100%;
        font-size: 0.6em; /* Smaller font for pencil marks */
        color: #555; /* Lighter color for pencil marks */
        font-weight: normal;
        gap: 1px;
        padding: 2px;
    }
    .sudoku-cell .pencil-marks div {
        display: flex;
        justify-content: center;
        align-items: center;
    }


    /* Darker background for 3x3 blocks */
    .sudoku-cell:nth-child(3n):not(:last-child) {
        border-right: 2px solid #555;
    }
    .sudoku-cell:nth-child(9n) {
        border-right: 1px solid #333; /* Reset for last column */
    }
    .sudoku-cell:nth-child(n) {
        border-bottom: 1px solid #333;
    }
    .sudoku-cell:nth-child(n + 19):nth-child(-n + 27),
    .sudoku-cell:nth-child(n + 46):nth-child(-n + 54) {
        border-bottom: 2px solid #555;
    }
    /* Specific styling for 3x3 block borders */
    .sudoku-cell:nth-child(3n+1) { border-left: 1px solid #333; }
    .sudoku-cell:nth-child(9n+1) { border-left: 1px solid #333; }

    .sudoku-cell.fixed {
      background-color: #4A6572;
      color: #F8F8F8;
      cursor: default;
    }

    .sudoku-cell.selected {
      background-color: #4682B4;
      box-shadow: inset 0 0 10px #4682B4;
    }

    .sudoku-cell.invalid {
      background-color: #FF6347;
      color: #fff;
    }

    .sudoku-cell.highlight-same-value {
        background-color: #87CEEB;
    }

    .sudoku-cell.highlight-group {
        background-color: rgba(116, 185, 255, 0.3);
    }

    /* Number input pad */
    #number-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: auto; /* Pushes to bottom of flex container */
      padding: 10px;
      border-radius: 8px;
      background: #2E4057;
    }

    #number-pad button {
      padding: 15px;
      background: #60A3D9;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.2em; /* Adjusted font size for desktop */
      cursor: pointer;
      box-shadow: 0 0 8px rgba(96, 163, 217, 0.5);
      transition: all 0.2s ease-in-out;
    }

    #number-pad button:hover {
      background: #7ABCEF;
      box-shadow: 0 0 12px rgba(122, 188, 239, 0.8);
      transform: translateY(-2px);
    }

    #number-pad button:active {
      transform: translateY(0);
      box-shadow: 0 0 4px rgba(96, 163, 217, 0.3);
    }

    #number-pad button.clear-button {
      grid-column: span 3; /* Clear button spans all columns */
      background: #FF6347;
      color: #fff;
    }
    #number-pad button.clear-button:hover {
        background: #FF7F50;
    }

    /* Game message box (for all messages) - same as chess */
    #game-message {
      position: relative;
      margin: 10px auto;
      background: rgba(0,0,0,0.8);
      padding: 10px 20px;
      border-radius: 8px;
      border: 2px solid #74B9FF;
      color: #74B9FF;
      font-size: 1.5em;
      font-weight: bold;
      text-shadow: 0 0 5px #74B9FF;
      display: none;
      text-align: center;
      width: fit-content;
      max-width: 80%;
      z-index: 1001;
    }

    /* Style for game over message - same as chess */
    #game-message.game-over-style {
      color: #FFD700;
      font-size: 2.5em;
      text-shadow: 0 0 20px #FFD700;
      padding: 20px 30px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #game-container {
        flex-direction: column;
        align-items: center;
        padding: 10px;
      }
      #game-box {
        width: 100%;
        max-width: none; /* Allow full width on mobile */
        padding: 1vw; /* Responsive padding on mobile */
      }
      #sidebar {
        width: 100%;
        max-width: none;
        margin-top: 20px;
      }
      #sudoku-board {
        width: 98vw; /* Adjusted to 98vw for more space */
        height: 98vw; /* Adjusted to 98vw */
        max-width: 630px; /* Still cap max size for larger tablets */
        max-height: 630px;
        margin: 1vw auto; /* Responsive margin on mobile */
      }
      .sudoku-cell {
        width: calc(98vw / 9); /* Ensures 9 cells fit within 98vw board */
        height: calc(98vw / 9);
        font-size: 5vw; /* Adjusted font size responsively */
      }
      .sudoku-cell .pencil-marks {
          font-size: 2vw; /* Smaller font for pencil marks on mobile */
          padding: 0.5vw;
      }
      #number-pad {
        margin-top: 1vw; /* Responsive margin on mobile */
        padding: 1.5vw; /* Responsive padding on mobile */
      }
      #number-pad button {
        font-size: 4vw; /* Responsive font size for buttons */
        padding: 2vw; /* Responsive padding */
      }
      .game-controls {
        margin-bottom: 2vw; /* Responsive margin on mobile */
        gap: 1.5vw; /* Responsive gap */
      }
      .game-controls button {
        font-size: 3.5vw; /* Responsive font size */
        padding: 1.2vw 2.5vw; /* Responsive padding */
      }
      .game-controls select {
        font-size: 3.5vw; /* Responsive font size */
        padding: 1.2vw 2.5vw;
      }
      #game-header {
        font-size: 6vw; /* Responsive header font size */
        margin-bottom: 2vw;
      }
      #game-version {
        font-size: 2.5vw;
        right: 3vw;
        top: 1.5vw;
      }
      #game-info {
        margin-bottom: 2vw;
        font-size: 3vw; /* Responsive info font size */
        gap: 2vw;
      }
      #game-info span {
        padding: 1vw 2vw;
      }
      #game-message {
        font-size: 4vw; /* Responsive messages font size */
        padding: 2vw 4vw;
        margin: 2vw auto;
      }
      #game-message.game-over-style {
        font-size: 6vw; /* Responsive game over message font size */
        padding: 3vw 5vw;
      }
    }
  </style>
</head>
<body>

  <!-- Site-wide header (fetched dynamically) -->
  <div id="site-header"></div>
  <script>
    fetch(window.location.origin + '/header.html')
      .then(r => r.text())
      .then(h => document.getElementById('site-header').innerHTML = h)
      .catch(e => console.error('Error fetching header:', e));
  </script>

  <div id="game-container">
    <div id="game-box">
      <div id="game-header">Sudoku üß© <span id="game-version">v1.7</span></div>
      <div id="game-info">
        <span>Difficulty: <span id="current-difficulty">Medium</span></span>
        <span id="game-status">Ready</span>
      </div>

      <div class="game-controls">
        <button id="newGameBtn">‚ú® New Game</button>
        <select id="difficultySelect">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
        </select>
        <button id="solveBtn">üí° Solve</button>
        <button id="pencilModeBtn">‚úèÔ∏è Pencil Mode</button>
        <button id="shareBtn">üîó Share with Friends</button>
        <button id="copyBtn">üìã Copy Link</button>
      </div>

      <!-- Game message box for notifications -->
      <div id="game-message"></div>

      <div id="sudoku-board">
        <!-- Sudoku cells will be dynamically generated here -->
      </div>

      <div id="number-pad">
        <button data-value="1">1</button>
        <button data-value="2">2</button>
        <button data-value="3">3</button>
        <button data-value="4">4</button>
        <button data-value="5">5</button>
        <button data-value="6">6</button>
        <button data-value="7">7</button>
        <button data-value="8">8</button>
        <button data-value="9">9</button>
        <button data-value="clear" class="clear-button">Clear</button>
      </div>
    </div>

    <!-- Sidebar (Donate section) -->
    <div id="sidebar">
      <h2>Support Us!</h2>
      <p>If you enjoy ad-free games from No Spin Media, consider supporting us.</p>
      <button id="donate-button" onclick="window.location.href='/sponsor.html'">Donate Now</button>
      <p style="font-size:0.8em; color:#aaa;">Your help keeps No Spin Media alive and growing.</p>
    </div>
  </div>

  <!-- Site-wide footer -->
  <footer style="text-align:center;color:#666;padding:10px;">
    ¬© 2025 No Spin Media. Independent. Ad-free. Truth-focused.
  </footer>

  <script>
    // --- Game State Variables ---
    let board = Array(9).fill(0).map(() => Array(9).fill(0)); // Current state of the board
    let solution = Array(9).fill(0).map(() => Array(9).fill(0)); // Solved board
    let initialBoard = Array(9).fill(0).map(() => Array(9).fill(0)); // Initial puzzle with fixed numbers
    let selectedCell = null; // { row, col } of the currently selected cell
    let difficulty = 'medium'; // 'easy', 'medium', 'hard'
    let messageTimeoutId = null; // To manage the hide timeout for temporary messages
    let gameEnded = false; // Flag to indicate if the game has ended
    let pencilMode = false; // New: Pencil mode state
    // New: Store pencil marks for each cell
    let pencilMarks = Array(9).fill(0).map(() => Array(9).fill(0).map(() => new Set()));


    // --- DOM Elements ---
    const sudokuBoardEl = document.getElementById('sudoku-board');
    const numberPadEl = document.getElementById('number-pad');
    const newGameBtn = document.getElementById('newGameBtn');
    const solveBtn = document.getElementById('solveBtn');
    const difficultySelect = document.getElementById('difficultySelect');
    const gameMessageEl = document.getElementById('game-message');
    const currentDifficultyEl = document.getElementById('current-difficulty');
    const gameStatusEl = document.getElementById('game-status');
    const pencilModeBtn = document.getElementById('pencilModeBtn'); // New: Pencil mode button

    // --- Sudoku Core Logic (Backtracking for Generation and Solving) ---

    // Function to check if a number is valid in a given cell
    function isValid(board, row, col, num) {
      // Check row
      for (let x = 0; x < 9; x++) {
        if (board[row][x] === num && x !== col) {
          return false;
        }
      }

      // Check column
      for (let x = 0; x < 9; x++) {
        if (board[x][col] === num && x !== row) {
          return false;
        }
      }

      // Check 3x3 box
      const startRow = row - (row % 3);
      const startCol = col - (col % 3);
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (board[i + startRow][j + startCol] === num && (i + startRow !== row || j + startCol !== col)) {
            return false;
          }
        }
      }
      return true;
    }

    // Function to find the next empty cell (0)
    function findEmpty(board) {
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (board[r][c] === 0) {
            return [r, c];
          }
        }
      }
      return null; // No empty cells
    }

    // Backtracking solver
    function solve(currentBoard) {
      const find = findEmpty(currentBoard);
      if (!find) {
        return true; // Board is solved
      }
      const [row, col] = find;

      for (let num = 1; num <= 9; num++) {
        if (isValid(currentBoard, row, col, num)) {
          currentBoard[row][col] = num;

          if (solve(currentBoard)) {
            return true;
          }

          currentBoard[row][col] = 0; // Backtrack
        }
      }
      return false; // No solution found
    }

    // --- Sudoku Puzzle Generation ---
    function generateSudoku(difficultyLevel) {
      // 1. Create a completely solved board
      let tempBoard = Array(9).fill(0).map(() => Array(9).fill(0));
      // Fill the board using the solver
      fillBoard(tempBoard);
      solution = JSON.parse(JSON.stringify(tempBoard)); // Store the full solution

      // 2. Remove numbers based on difficulty
      let cellsToRemove = 0;
      switch (difficultyLevel) {
        case 'easy':
          cellsToRemove = 40; // Fewer cells removed for easier puzzles
          break;
        case 'medium':
          cellsToRemove = 50; // Standard number
          break;
        case 'hard':
          cellsToRemove = 60; // More cells removed for harder puzzles
          break;
      }

      let count = 0;
      while (count < cellsToRemove) {
        const row = Math.floor(Math.random() * 9);
        const col = Math.floor(Math.random() * 9);

        if (tempBoard[row][col] !== 0) {
          const tempValue = tempBoard[row][col];
          tempBoard[row][col] = 0; // Temporarily remove

          // Check if the puzzle is still solvable (simple check, not uniqueness)
          let testBoard = JSON.parse(JSON.stringify(tempBoard));
          if (solve(testBoard)) {
            count++;
          } else {
            tempBoard[row][col] = tempValue; // If not solvable, put it back
          }
        }
      }
      initialBoard = JSON.parse(JSON.stringify(tempBoard)); // Store the initial puzzle
      board = JSON.parse(JSON.stringify(tempBoard)); // Set current board to the puzzle
      // Reset pencil marks for new game
      pencilMarks = Array(9).fill(0).map(() => Array(9).fill(0).map(() => new Set()));
    }

    // Helper to fill a board for generation (different from solve, ensures a full board)
    function fillBoard(currentBoard) {
        for (let i = 0; i < 81; i++) {
            let row = Math.floor(i / 9);
            let col = i % 9;
            if (currentBoard[row][col] === 0) {
                let numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5); // Randomize numbers
                for (let num of numbers) {
                    if (isValid(currentBoard, row, col, num)) {
                        currentBoard[row][col] = num;
                        if (fillBoard(currentBoard)) {
                            return true;
                        } else {
                            currentBoard[row][col] = 0; // Backtrack
                        }
                    }
                }
                return false;
            }
        }
        return true;
    }


    // --- Game Initialization ---
    function initializeGame() {
      gameEnded = false;
      selectedCell = null;
      hideGameMessage();
      generateSudoku(difficulty); // Generate a new puzzle
      renderBoard();
      updateHUD();
      gameStatusEl.textContent = 'Playing';
      pencilMode = false; // Reset pencil mode on new game
      pencilModeBtn.classList.remove('active-mode');
    }

    // --- Rendering Functions ---
    function renderBoard() {
      sudokuBoardEl.innerHTML = ''; // Clear existing board
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          const cellEl = document.createElement('div');
          cellEl.classList.add('sudoku-cell');
          cellEl.dataset.row = r;
          cellEl.dataset.col = c;

          // Add classes for 3x3 block borders
          if (r % 3 === 0 && r !== 0) {
            cellEl.style.borderTopWidth = '2px';
            cellEl.style.borderTopColor = '#555';
          }
          if (c % 3 === 0 && c !== 0) {
            cellEl.style.borderLeftWidth = '2px';
            cellEl.style.borderLeftColor = '#555';
          }

          if (initialBoard[r][c] !== 0) {
            cellEl.textContent = initialBoard[r][c];
            cellEl.classList.add('fixed'); // Fixed numbers cannot be changed
          } else if (board[r][c] !== 0) {
            cellEl.textContent = board[r][c];
            // If a main number is present, clear pencil marks for that cell
            pencilMarks[r][c].clear();
          } else {
            // Render pencil marks if no main number is present
            const pencilMarksContainer = document.createElement('div');
            pencilMarksContainer.classList.add('pencil-marks');
            for (let i = 1; i <= 9; i++) {
                const markEl = document.createElement('div');
                if (pencilMarks[r][c].has(i)) {
                    markEl.textContent = i;
                }
                pencilMarksContainer.appendChild(markEl);
            }
            cellEl.appendChild(pencilMarksContainer);
          }

          cellEl.addEventListener('click', handleCellClick);
          sudokuBoardEl.appendChild(cellEl);
        }
      }
      highlightSelectedCell();
    }

    function highlightSelectedCell() {
        document.querySelectorAll('.sudoku-cell').forEach(cellEl => {
            cellEl.classList.remove('selected', 'invalid', 'highlight-same-value', 'highlight-group');
        });

        if (selectedCell) {
            const { row, col } = selectedCell;
            const selectedEl = document.querySelector(`.sudoku-cell[data-row="${row}"][data-col="${col}"]`);
            if (selectedEl) {
                selectedEl.classList.add('selected');
            }

            // Highlight row, column, and 3x3 block
            for (let i = 0; i < 9; i++) {
                document.querySelector(`.sudoku-cell[data-row="${row}"][data-col="${i}"]`).classList.add('highlight-group');
                document.querySelector(`.sudoku-cell[data-row="${i}"][data-col="${col}"]`).classList.add('highlight-group');
            }
            const startRow = row - (row % 3);
            const startCol = col - (col % 3);
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    document.querySelector(`.sudoku-cell[data-row="${i + startRow}"][data-col="${j + startCol}"]`).classList.add('highlight-group');
                }
            }

            // Highlight cells with the same value as the selected cell (if it has a value)
            const selectedValue = board[row][col];
            if (selectedValue !== 0) {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (board[r][c] === selectedValue) {
                            document.querySelector(`.sudoku-cell[data-row="${r}"][data-col="${c}"]`).classList.add('highlight-same-value');
                        }
                    }
                }
            }
        }
    }

    function updateHUD() {
      currentDifficultyEl.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
    }

    // Function to display messages. If isGameOver is true, message persists.
    function displayGameMessage(message, isGameOver = false) {
      clearTimeout(messageTimeoutId); // Clear any existing timeout
      messageTimeoutId = null;

      gameMessageEl.textContent = message;
      gameMessageEl.style.display = 'block';
      if (isGameOver) {
        gameMessageEl.classList.add('game-over-style'); // Add style for game over
      } else {
        gameMessageEl.classList.remove('game-over-style'); // Remove style for temporary messages
        messageTimeoutId = setTimeout(hideGameMessage, 2000); // Hide temporary messages after 2 seconds
      }
    }

    function hideGameMessage() {
      gameMessageEl.style.display = 'none';
      gameMessageEl.classList.remove('game-over-style'); // Ensure style is removed when hidden
    }

    // --- Game Logic ---
    function handleCellClick(event) {
      if (gameEnded) {
        displayGameMessage("Game over! Start a New Game.");
        return;
      }

      const row = parseInt(event.currentTarget.dataset.row);
      const col = parseInt(event.currentTarget.dataset.col);

      if (initialBoard[row][col] !== 0) {
        selectedCell = null; // Cannot select fixed cells
        displayGameMessage("This is a fixed number!");
      } else {
        selectedCell = { row, col };
      }
      highlightSelectedCell();
    }

    function handleNumberInput(event) {
      if (!selectedCell || gameEnded) return;

      const value = event.target.dataset.value;
      const { row, col } = selectedCell;

      if (initialBoard[row][col] !== 0) { // Cannot change fixed cells
        displayGameMessage("Cannot change fixed numbers!");
        return;
      }

      if (pencilMode) {
        // Pencil mode logic
        if (value === 'clear') {
          pencilMarks[row][col].clear(); // Clear all pencil marks
        } else {
          const num = parseInt(value);
          if (pencilMarks[row][col].has(num)) {
            pencilMarks[row][col].delete(num); // Toggle off
          } else {
            pencilMarks[row][col].add(num); // Toggle on
          }
        }
        board[row][col] = 0; // Ensure main number is cleared in pencil mode
      } else {
        // Normal input mode logic
        if (value === 'clear') {
          board[row][col] = 0;
        } else {
          const num = parseInt(value);
          board[row][col] = num;
          pencilMarks[row][col].clear(); // Clear pencil marks when setting a main number
        }
      }

      renderBoard(); // Re-render board to show changes

      // Validate the current input if it's not a clear and not in pencil mode
      if (value !== 'clear' && !pencilMode) {
        if (!isValid(board, row, col, board[row][col])) {
          document.querySelector(`.sudoku-cell[data-row="${row}"][data-col="${col}"]`).classList.add('invalid');
          displayGameMessage("Invalid move!");
        } else {
          // If valid, check for win condition
          if (checkWin()) {
            displayGameMessage("Congratulations! You solved the Sudoku!", true);
            gameStatusEl.textContent = 'Solved!';
            gameEnded = true;
          } else {
            gameStatusEl.textContent = 'Playing';
          }
        }
      } else if (pencilMode) {
          gameStatusEl.textContent = 'Pencil Mode Active';
      } else {
          gameStatusEl.textContent = 'Playing';
      }
    }


    function checkWin() {
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (board[r][c] === 0 || !isValid(board, r, c, board[r][c])) {
            return false;
          }
        }
      }
      return true;
    }

    function solveCurrentPuzzle() {
        if (gameEnded) {
            displayGameMessage("Game over! Start a New Game to solve a new puzzle.");
            return;
        }
        // Use the stored solution to fill the board
        board = JSON.parse(JSON.stringify(solution));
        pencilMarks = Array(9).fill(0).map(() => Array(9).fill(0).map(() => new Set())); // Clear pencil marks
        renderBoard();
        updateHUD();
        displayGameMessage("Puzzle solved!", true);
        gameStatusEl.textContent = 'Solved!';
        gameEnded = true;
        selectedCell = null; // Deselect any cell
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      newGameBtn.addEventListener('click', initializeGame);
      solveBtn.addEventListener('click', solveCurrentPuzzle);

      pencilModeBtn.addEventListener('click', () => {
        pencilMode = !pencilMode;
        if (pencilMode) {
          pencilModeBtn.classList.add('active-mode');
          displayGameMessage("Pencil Mode ON. Enter notes.");
          gameStatusEl.textContent = 'Pencil Mode Active';
        } else {
          pencilModeBtn.classList.remove('active-mode');
          displayGameMessage("Pencil Mode OFF. Enter final answers.");
          gameStatusEl.textContent = 'Playing';
        }
      });

      difficultySelect.addEventListener('change', (event) => {
        difficulty = event.target.value;
        initializeGame();
        displayGameMessage(`Difficulty set to ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`);
      });

      numberPadEl.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', handleNumberInput);
      });

      // Share and Copy Link buttons (same as Chess)
      document.getElementById('shareBtn').onclick = () => {
        if (navigator.share) {
          navigator.share({
            title: "Sudoku - No Spin Media",
            url: window.location.href
          }).catch((error) => console.error('Error sharing:', error));
        } else {
          const dummyTextArea = document.createElement('textarea');
          dummyTextArea.value = window.location.href;
          document.body.appendChild(dummyTextArea);
          dummyTextArea.select();
          document.execCommand('copy');
          document.body.removeChild(dummyTextArea);
          displayGameMessage("Link copied to clipboard!");
        }
      };
      document.getElementById('copyBtn').onclick = () => {
        const dummyTextArea = document.createElement('textarea');
        dummyTextArea.value = window.location.href;
        document.body.appendChild(dummyTextArea);
        dummyTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(dummyTextArea);
        displayGameMessage("Link copied to clipboard!");
      };

      // Initial game setup
      initializeGame();
    });
  </script>
</body>
</html>
