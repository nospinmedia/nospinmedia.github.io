<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galactic Siege - No Spin Media</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body { background:#000; color:#fff; margin:0; font-family:Arial,sans-serif; }
    #game-container { display:flex; justify-content:center; padding:20px; gap:30px; flex-wrap:wrap; }
    #game-box { border:2px solid #0f0; box-shadow:0 0 20px #0f0; padding:10px; border-radius:8px; background:#000; position:relative; }
    #game-header { color:#0f0; text-align:center; font-size:1.8em; margin-bottom:5px; text-shadow:0 0 8px #0f0; position:relative; }
    #game-version { position:absolute; top:5px; right:10px; color:#0f0; font-size:0.8em; } /* Version style */
    #game-info { text-align:center; color:#0f0; margin-bottom:10px; font-weight:bold; }
    canvas { background:#000; border:2px solid #0f0; display:block; margin:auto; }
    #sidebar { background:#111; border:2px solid #0f0; box-shadow:0 0 15px #0f0; padding:20px; border-radius:8px; max-width:250px; height:fit-content; }
    #sidebar h2 { color:#0f0; text-align:center; }
    #donate-button { background:#ffd700; color:#000; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin:10px auto; display:block; }
    #overlay {
      position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8);
      color:#0f0; display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; font-size:2em; font-weight:bold; text-shadow:0 0 8px #0f0; z-index:5;
    }
    .overlay-btn {
      background:#0f0; color:#000; font-weight:bold; padding:0.5rem 1rem; margin-top:1rem;
      border:none; border-radius:6px; cursor:pointer; font-size:1.2rem; box-shadow:0 0 10px #0f0;
    }
    .share-buttons { text-align:center; margin:10px; }
    .share-buttons button {
      padding:6px 12px; margin:0 5px; background:#0073e6; color:#fff;
      border:none; border-radius:4px; cursor:pointer; font-weight:bold;
    }
  </style>
</head>
<body>

  <div id="site-header"></div>
  <script>
    fetch('/header.html')
      .then(r=>r.text())
      .then(h=>document.getElementById('site-header').innerHTML=h);
  </script>

  <div id="game-container">
    <div id="game-box">
      <div id="game-header">Galactic Siege üëæ <span id="game-version">v1.8</span></div> <div id="game-info">
        Score: <span id="score">0</span> | Lives: <span id="lives">3</span> | High Score: <span id="highScore">0</span> | Level: <span id="level">1</span>
      </div>

      <div class="share-buttons">
        <button id="shareBtn">üîó Share with Friends</button>
        <button id="copyBtn">üìã Copy Link</button>
        <button id="soundToggleBtn">üîä Sound On/Off</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button id="endGameBtn">üõë End Game</button>
      </div>

      <canvas id="gameCanvas" width="600" height="500"></canvas>

      <div id="overlay">
        <div>Galactic Siege</div>
        <button class="overlay-btn" id="startBtn">Start Game</button>
      </div>
    </div>

    <div id="sidebar">
      <h2>Support Us!</h2>
      <p>If you enjoy ad-free games from No Spin Media, consider supporting us.</p>
      <button id="donate-button" onclick="window.location.href='/sponsor.html'">Donate Now</button>
      <p style="font-size:0.8em; color:#aaa;">Your help keeps No Spin Media alive and growing.</p>
    </div>
  </div>

  <footer style="text-align:center;color:#666;padding:10px;">
    ¬© 2025 No Spin Media. Independent. Ad-free. Truth-focused.
  </footer>

  <script>
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d');

    let player, bullets=[], aliens=[], alienBullets=[], shields=[];
    let score=0, lives=3, level=1;
    let highScore=localStorage.getItem('galacticSiegeHS')||0;
    let alienDir=1, alienSpeed=0.5;
    let gameRunning=false, nextWaveTimer=0;
    let alienShootTimer = 60; // How often aliens shoot
    let playerExplosionTimer = 0; // Timer for player explosion animation
    let gamePaused = false; // New: Game pause state
    let animationFrameId; // To store the requestAnimationFrame ID

    let soundEnabled = true; // Initial sound state
    let audioContext;
    let shootBuffer, explosionBuffer; // To hold decoded audio data

    const PLAYER_SPEED=6, BULLET_SPEED=7, ALIEN_BULLET_SPEED=3;
    const PLAYER_WIDTH=40, PLAYER_HEIGHT=30;

    const ALIEN_ROWS=3, ALIEN_COLS=8;
    const ALIEN_SIZE=20;

    const SHIELD_BLOCK=5, SHIELD_WIDTH=60, SHIELD_HEIGHT=20;

    // --- Sound Functions (using Web Audio API) ---
    async function loadSound(url) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.error('Error loading sound:', url, error);
            return null;
        }
    }

    function playSound(buffer, volume = 1.0) {
        if (!soundEnabled || !audioContext || !buffer) return;

        try {
            const source = audioContext.createBufferSource();
            source.buffer = buffer;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;

            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start(0);
        } catch (error) {
            console.error('Error playing sound:', error);
        }
    }

    // --- Game Logic and Drawing Functions ---
    function initPlayer(){
      player={x:canvas.width/2-PLAYER_WIDTH/2,y:canvas.height-PLAYER_HEIGHT-10,width:PLAYER_WIDTH,height:PLAYER_HEIGHT,dx:0, alive:true};
    }

    function createAliens(flyIn=false){
      aliens=[];
      const startX=50, startY=50, spacingX=50, spacingY=40;
      for(let r=0;r<ALIEN_ROWS;r++){
        for(let c=0;c<ALIEN_COLS;c++){
          aliens.push({
            x:startX+c*spacingX,
            y:flyIn ? -60 - (r * spacingY) : r*spacingY+startY, // Start above if flying in
            targetY:r*spacingY+startY,
            width: ALIEN_SIZE, // Add width for collision
            height: ALIEN_SIZE, // Add height for collision
            type:r
          });
        }
      }
    }

    function createShields(){
      shields=[];
      const gap=(canvas.width-(4*SHIELD_WIDTH))/5;
      for(let i=0;i<4;i++){
        const rows=SHIELD_HEIGHT/SHIELD_BLOCK, cols=SHIELD_WIDTH/SHIELD_BLOCK;
        const dmg=Array.from({length:rows},()=>Array(cols).fill(0));
        shields.push({x:gap*(i+1)+i*SHIELD_WIDTH,y:canvas.height-100,width:SHIELD_WIDTH,height:SHIELD_HEIGHT,damage:dmg});
      }
    }

    function drawPlayer(){
      if (player.alive) {
        ctx.fillStyle="#fff";
        ctx.beginPath();
        ctx.moveTo(player.x+player.width/2,player.y); // nose
        ctx.lineTo(player.x,player.y+player.height);
        ctx.lineTo(player.x+player.width,player.y+player.height);
        ctx.closePath(); ctx.fill();
        ctx.fillStyle="#00f";
        ctx.fillRect(player.x+player.width/2-5,player.y+10,10,8);
      } else if (playerExplosionTimer > 0) {
        // Draw explosion animation (simple circles for now)
        const radius = (120 - playerExplosionTimer) * 0.5; // Grow explosion
        ctx.fillStyle = `rgba(255, ${255 - (120 - playerExplosionTimer) * 2}, 0, ${playerExplosionTimer / 120})`; // Orange to red fade
        ctx.beginPath();
        ctx.arc(player.x + player.width / 2, player.y + player.height / 2, radius, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = `rgba(255, 255, 255, ${playerExplosionTimer / 120 * 0.7})`; // White sparks
        for (let i = 0; i < 7; i++) {
          const angle = Math.random() * Math.PI * 2;
          const dist = Math.random() * radius;
          ctx.beginPath();
          ctx.arc(player.x + player.width / 2 + Math.cos(angle) * dist, player.y + player.height / 2 + Math.sin(angle) * dist, 2, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }

    function drawAlien(a){
      ctx.save();
      ctx.translate(a.x,a.y);
      ctx.fillStyle="#0f0";
      // Alien Type 0 (Crab-like)
      if(a.type===0){
        ctx.fillRect(4,0,12,4);
        ctx.fillRect(2,4,16,4);
        ctx.fillRect(0,8,20,4);
        ctx.fillRect(2,12,16,4);
        ctx.fillRect(4,16,4,4);
        ctx.fillRect(12,16,4,4);
      }
      // Alien Type 1 (Squid-like)
      else if(a.type===1){
        ctx.fillRect(6,0,8,4);
        ctx.fillRect(4,4,12,4);
        ctx.fillRect(2,8,16,4);
        ctx.fillRect(0,12,20,4);
        ctx.fillRect(6,16,2,4);
        ctx.fillRect(12,16,2,4);
      }
      // Alien Type 2 (Bug-like)
      else if(a.type===2){
        ctx.fillRect(6,0,8,4);
        ctx.fillRect(4,4,12,4);
        ctx.fillRect(2,8,16,4);
        ctx.fillRect(0,12,20,4);
        ctx.fillRect(4,16,4,4);
        ctx.fillRect(12,16,4,4);
      }
      ctx.restore();
    }

    function drawShields(){
      shields.forEach(s=>{
        for(let r=0;r<s.damage.length;r++){
          for(let c=0;c<s.damage[r].length;c++){
            if(s.damage[r][c]<3){
              const hp=3-s.damage[r][c]; // 3=full, 2=medium, 1=low
              ctx.fillStyle=hp===3?"#0f0":hp===2?"#ffa500":"#f00"; // Green, Orange, Red
              ctx.fillRect(s.x+c*SHIELD_BLOCK,s.y+r*SHIELD_BLOCK,SHIELD_BLOCK,SHIELD_BLOCK);
            }
          }
        }
      });
    }

    function drawBullets(){
        bullets.forEach((b)=>{
            ctx.fillStyle="#0ff";
            ctx.fillRect(b.x,b.y,3,10);
        });
    }

    function drawAlienBullets(){
        alienBullets.forEach((b) => {
            ctx.fillStyle = "#f00";
            ctx.fillRect(b.x, b.y, 3, 10);
        });
    }

    function update(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // --- Drawing Phase (Always draws visible elements based on current state) ---
      // This ensures everything is visible even if game is paused or on start screen
      drawPlayer();
      aliens.forEach(drawAlien);
      drawShields();
      drawBullets();
      drawAlienBullets();

      if(nextWaveTimer>0){
        ctx.fillStyle="#0f0"; ctx.font="bold 40px Arial"; ctx.textAlign="center";
        ctx.fillText(`Next Wave in ${Math.ceil(nextWaveTimer/60)}`,canvas.width/2,canvas.height/2);
        nextWaveTimer--;
      }

      // Display PAUSED message if game is paused
      if (gamePaused) {
          ctx.fillStyle="#0f0"; ctx.font="bold 40px Arial"; ctx.textAlign="center";
          ctx.fillText("PAUSED",canvas.width/2,canvas.height/2);
      }


      // --- Game Logic Phase (Only runs if game is running and not paused) ---
      if (gameRunning && !gamePaused) {

        // Player explosion timer countdown (happens regardless of whether game logic runs fully)
        if (playerExplosionTimer > 0) {
            playerExplosionTimer--;
            if (playerExplosionTimer === 0) {
                if (lives > 0) { // If lives remain, reset player for next life
                    initPlayer();
                    player.alive = true;
                    alienBullets = []; // Clear any alien bullets that might still be on screen
                    updateHUD();
                } else { // No lives left, it's game over
                    gameOver();
                    // Crucially, stop processing further game logic if game over
                    animationFrameId = requestAnimationFrame(update); // Still need to request next frame to show game over
                    return;
                }
            }
        }

        // Only run main game logic if player is alive (or not currently exploding from a hit)
        if (player.alive) {
            // Player movement
            player.x+=player.dx;
            if(player.x<0)player.x=0;
            if(player.x+player.width>canvas.width)player.x=canvas.width-player.width;

            // Player Bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.y-=BULLET_SPEED;

                if(b.y<0) {
                    bullets.splice(i,1);
                    continue;
                }

                for (let j = aliens.length - 1; j >= 0; j--) {
                    const a = aliens[j];
                    if(checkCollision(b, {x: a.x, y: a.y, width: ALIEN_SIZE, height: ALIEN_SIZE})){
                        aliens.splice(j,1);
                        bullets.splice(i,1);
                        score+=10; updateHUD();
                        break;
                    }
                }
                if (i >= bullets.length) continue;

                for (let sIndex = 0; sIndex < shields.length; sIndex++) {
                    const s = shields[sIndex];
                    for(let r=0; r<s.damage.length; r++) {
                        for(let c=0; c<s.damage[r].length; c++) {
                            if (s.damage[r][c] < 3) {
                                const blockX = s.x + c * SHIELD_BLOCK;
                                const blockY = s.y + r * SHIELD_BLOCK;
                                if (checkCollision(b, {x: blockX, y: blockY, width: SHIELD_BLOCK, height: SHIELD_BLOCK})) {
                                    s.damage[r][c]++;
                                    bullets.splice(i,1);
                                    break;
                                }
                            }
                        }
                    }
                    if (i >= bullets.length) break;
                }
            }
        } // End if (player.alive)


        // Alien Bullets (Always process as they exist independently of player's life state)
        for (let i = alienBullets.length - 1; i >= 0; i--) {
            const b = alienBullets[i];
            b.y += ALIEN_BULLET_SPEED;

            if (b.y > canvas.height) {
                alienBullets.splice(i, 1);
                continue;
            }

            if (player.alive && checkCollision(b, player)) {
              alienBullets.splice(i, 1);
              lives--;
              playSound(explosionBuffer, 0.8); // Play explosion sound
              player.alive = false; // Player is hit, now exploding
              playerExplosionTimer = 120; // Start explosion animation
              updateHUD();
              continue; // Continue to next bullet, this one is done
            }

            for (let sIndex = 0; sIndex < shields.length; sIndex++) {
                const s = shields[sIndex];
                for(let r=0; r<s.damage.length; r++) {
                    for(let c=0; c<s.damage[r].length; c++) {
                        if (s.damage[r][c] < 3) {
                            const blockX = s.x + c * SHIELD_BLOCK;
                            const blockY = s.y + r * SHIELD_BLOCK;
                            if (checkCollision(b, {x: blockX, y: blockY, width: SHIELD_BLOCK, height: SHIELD_BLOCK})) {
                                s.damage[r][c]++;
                                alienBullets.splice(i, 1);
                                break;
                            }
                        }
                    }
                }
                if (i >= alienBullets.length) break;
            }
        }


        // Aliens movement and flying in animation
        let edge=false;
        aliens.forEach(a=>{
          if (a.y < a.targetY) {
            a.y += 1;
          } else {
            a.x+=alienDir*alienSpeed;
            if(a.x<0 || a.x+ALIEN_SIZE>canvas.width) edge=true;
          }
        });
        if(edge){
          alienDir*=-1;
          aliens.forEach(a=>a.y+=10);
        }

        // Alien shooting logic
        alienShootTimer--;
        if (alienShootTimer <= 0 && aliens.length > 0) {
          const shootingAlien = aliens[Math.floor(Math.random() * aliens.length)];
          alienBullets.push({x: shootingAlien.x + ALIEN_SIZE / 2 - 1.5, y: shootingAlien.y + ALIEN_SIZE, width:3, height:10});
          alienShootTimer = 60 - (level * 5);
          if (alienShootTimer < 20) alienShootTimer = 20;
        }

        // Check bottom collision (aliens reaching bottom of screen)
        aliens.forEach(a=>{
          if(a.y+ALIEN_SIZE>canvas.height-60){
            if (player.alive) { // Only trigger loss of life if player hasn't been hit already this frame
              playSound(explosionBuffer, 0.8); // Play explosion sound
              player.alive = false; // Player is hit, now exploding
              playerExplosionTimer = 120; // Start explosion animation
              updateHUD();
            }
          }
        });

        // Next level
        if(aliens.length===0){
          level++;
          alienSpeed+=0.2;
          nextWaveTimer=180;
          createAliens(true);
          createShields();
        }
      } // End if (gameRunning && !gamePaused)

      animationFrameId = requestAnimationFrame(update); // Request next frame for continuous loop
    }

    function updateHUD(){
      document.getElementById('score').innerText=score;
      document.getElementById('lives').innerText=lives;
      document.getElementById('level').innerText=level;
      document.getElementById('highScore').innerText=highScore;
    }

    async function startGame(){
      // Initialize AudioContext and load sounds on first user interaction
      if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();

          // Resume context if it's suspended (common browser policy)
          if (audioContext.state === 'suspended') {
              audioContext.resume();
          }

          // Load sounds only once
          shootBuffer = await loadSound('https://www.soundjay.com/buttons/beep-07.wav');
          explosionBuffer = await loadSound('https://www.soundjay.com/misc/explosion-01.wav');
      }


      if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
      }

      score=0; lives=3; level=1; alienSpeed=0.5; alienShootTimer = 60;
      initPlayer();
      createAliens(true);
      createShields();
      bullets = [];
      alienBullets = [];
      playerExplosionTimer = 0;
      gamePaused = false;
      document.getElementById('pauseBtn').innerText = '‚è∏Ô∏è Pause';
      updateHUD(); gameRunning=true;
      document.getElementById('overlay').style.display="none";

      update(); // Start the game loop
    }

    function gameOver(){
      gameRunning=false;
      if(score>highScore){ highScore=score; localStorage.setItem('galacticSiegeHS',highScore); }
      updateHUD();
      const overlay=document.getElementById('overlay');
      overlay.innerHTML=`<div>Game Over</div><button class="overlay-btn" id="startBtn">Play Again</button>`;
      document.getElementById('startBtn').onclick=startGame;
      overlay.style.display="flex";
    }

    function togglePause() {
        if (!gameRunning && playerExplosionTimer === 0) return;

        gamePaused = !gamePaused;
        if (gamePaused) {
            document.getElementById('pauseBtn').innerText = '‚ñ∂Ô∏è Resume';
            if (audioContext && audioContext.state === 'running') {
                audioContext.suspend(); // Suspend audio context when pausing
            }
        } else {
            document.getElementById('pauseBtn').innerText = '‚è∏Ô∏è Pause';
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume(); // Resume audio context when resuming
            }
            if (!animationFrameId) {
                update();
            }
        }
    }

    function endGame() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        gameRunning = false;
        gamePaused = false;
        playerExplosionTimer = 0;
        score=0; lives=3; level=1;
        bullets = [];
        alienBullets = [];
        aliens = [];
        shields = [];
        initPlayer();
        createShields();
        updateHUD();

        const overlay=document.getElementById('overlay');
        overlay.innerHTML=`<div>Galactic Siege</div><button class="overlay-btn" id="startBtn">Start Game</button>`;
        document.getElementById('startBtn').onclick=startGame;
        overlay.style.display="flex";

        // Stop audio context completely when ending the game
        if (audioContext) {
            audioContext.close();
            audioContext = null; // Reset for a fresh start next game
            shootBuffer = null;
            explosionBuffer = null;
        }
    }


    document.addEventListener('keydown',e=>{
      if(e.key==="ArrowLeft" && player.alive && !gamePaused) player.dx=-PLAYER_SPEED;
      if(e.key==="ArrowRight" && player.alive && !gamePaused) player.dx=PLAYER_SPEED;
      if(e.key===" " && gameRunning && player.alive && !gamePaused){
        bullets.push({x:player.x+player.width/2-1.5,y:player.y, width:3, height:10});
        playSound(shootBuffer, 0.5); // Play shoot sound
      }
    });
    document.addEventListener('keyup',e=>{
      if(e.key==="ArrowLeft"||e.key==="ArrowRight") player.dx=0;
    });

    // Event listeners
    document.getElementById('startBtn').onclick=startGame;
    document.getElementById('shareBtn').onclick=()=>{navigator.share?navigator.share({title:"Galactic Siege",url:location.href}):navigator.clipboard.writeText(location.href).then(()=>alert("Link copied"));};
    document.getElementById('copyBtn').onclick=()=>{navigator.clipboard.writeText(location.href).then(()=>alert("Link copied"));};
    document.getElementById('soundToggleBtn').onclick=()=>{
      soundEnabled = !soundEnabled;
      document.getElementById('soundToggleBtn').innerText = soundEnabled ? 'üîä Sound On/Off' : 'üîá Sound On/Off';
      // Attempt to resume/suspend context immediately if it exists and is relevant
      if (audioContext) {
          if (soundEnabled && audioContext.state === 'suspended') {
              audioContext.resume();
          } else if (!soundEnabled && audioContext.state === 'running') {
              audioContext.suspend();
          }
      }
    };
    document.getElementById('pauseBtn').onclick=togglePause;
    document.getElementById('endGameBtn').onclick=endGame;


    // Initial setup
    initPlayer();
    createShields();
    updateHUD();
    // The overlay should be displayed by default, waiting for the user to click "Start Game"
  </script>
</body>
</html>
