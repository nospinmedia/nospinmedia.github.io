<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galactic Siege - No Spin Media</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body { background:#000; color:#fff; margin:0; font-family:Arial,sans-serif; }
    #game-container { display:flex; justify-content:center; padding:20px; gap:30px; flex-wrap:wrap; }
    #game-box { border:2px solid #0f0; box-shadow:0 0 20px #0f0; padding:10px; border-radius:8px; background:#000; position:relative; }
    #game-header { color:#0f0; text-align:center; font-size:1.8em; margin-bottom:5px; text-shadow:0 0 8px #0f0; }
    #game-info { text-align:center; color:#0f0; margin-bottom:10px; font-weight:bold; }
    canvas { background:#000; border:2px solid #0f0; display:block; margin:auto; }
    #sidebar { background:#111; border:2px solid #0f0; box-shadow:0 0 15px #0f0; padding:20px; border-radius:8px; max-width:250px; height:fit-content; }
    #sidebar h2 { color:#0f0; text-align:center; }
    #donate-button { background:#ffd700; color:#000; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin:10px auto; display:block; }
    #overlay {
      position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8);
      color:#0f0; display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; font-size:2em; font-weight:bold; text-shadow:0 0 8px #0f0; z-index:5;
    }
    .overlay-btn {
      background:#0f0; color:#000; font-weight:bold; padding:0.5rem 1rem; margin-top:1rem;
      border:none; border-radius:6px; cursor:pointer; font-size:1.2rem; box-shadow:0 0 10px #0f0;
    }
    .share-buttons { text-align:center; margin:10px; }
    .share-buttons button {
      padding:6px 12px; margin:0 5px; background:#0073e6; color:#fff;
      border:none; border-radius:4px; cursor:pointer; font-weight:bold;
    }
  </style>
</head>
<body>

  <div id="site-header"></div>
  <script>
    fetch('/header.html')
      .then(r=>r.text())
      .then(h=>document.getElementById('site-header').innerHTML=h);
  </script>

  <div id="game-container">
    <div id="game-box">
      <div id="game-header">Galactic Siege üëæ</div>
      <div id="game-info">
        Score: <span id="score">0</span> | Lives: <span id="lives">3</span> | High Score: <span id="highScore">0</span> | Level: <span id="level">1</span>
      </div>

      <div class="share-buttons">
        <button id="shareBtn">üîó Share with Friends</button>
        <button id="copyBtn">üìã Copy Link</button>
        <button id="soundToggleBtn">üîä Sound On/Off</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button id="endGameBtn">üõë End Game</button>
      </div>

      <canvas id="gameCanvas" width="600" height="500"></canvas>

      <div id="overlay">
        <div>Galactic Siege</div>
        <button class="overlay-btn" id="startBtn">Start Game</button>
      </div>
    </div>

    <div id="sidebar">
      <h2>Support Us!</h2>
      <p>If you enjoy ad-free games from No Spin Media, consider supporting us.</p>
      <button id="donate-button" onclick="window.location.href='/sponsor.html'">Donate Now</button>
      <p style="font-size:0.8em; color:#aaa;">Your help keeps No Spin Media alive and growing.</p>
    </div>
  </div>

  <footer style="text-align:center;color:#666;padding:10px;">
    ¬© 2025 No Spin Media. Independent. Ad-free. Truth-focused.
  </footer>

  <script>
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d');

    let player, bullets=[], aliens=[], alienBullets=[], shields=[];
    let score=0, lives=3, level=1;
    let highScore=localStorage.getItem('galacticSiegeHS')||0;
    let alienDir=1, alienSpeed=0.5;
    let gameRunning=false, nextWaveTimer=0;
    let alienShootTimer = 60; // How often aliens shoot
    let playerExplosionTimer = 0; // Timer for player explosion animation
    let gamePaused = false; // New: Game pause state

    let soundEnabled = true; // Initial sound state
    const shootSound = new Audio('https://www.soundjay.com/buttons/beep-07.wav'); // Example sound
    const explosionSound = new Audio('https://www.soundjay.com/misc/explosion-01.wav'); // Example explosion sound
    shootSound.volume = 0.2;
    explosionSound.volume = 0.5;

    const PLAYER_SPEED=6, BULLET_SPEED=7, ALIEN_BULLET_SPEED=3;
    const PLAYER_WIDTH=40, PLAYER_HEIGHT=30;

    const ALIEN_ROWS=3, ALIEN_COLS=8;
    const ALIEN_SIZE=20;

    const SHIELD_BLOCK=5, SHIELD_WIDTH=60, SHIELD_HEIGHT=20;

    function initPlayer(){
      player={x:canvas.width/2-PLAYER_WIDTH/2,y:canvas.height-PLAYER_HEIGHT-10,width:PLAYER_WIDTH,height:PLAYER_HEIGHT,dx:0, alive:true};
    }

    function createAliens(flyIn=false){
      aliens=[];
      const startX=50, startY=50, spacingX=50, spacingY=40;
      for(let r=0;r<ALIEN_ROWS;r++){
        for(let c=0;c<ALIEN_COLS;c++){
          aliens.push({
            x:startX+c*spacingX,
            y:flyIn ? -60 - (r * spacingY) : r*spacingY+startY, // Start above if flying in
            targetY:r*spacingY+startY,
            width: ALIEN_SIZE, // Add width for collision
            height: ALIEN_SIZE, // Add height for collision
            type:r
          });
        }
      }
    }

    function createShields(){
      shields=[];
      const gap=(canvas.width-(4*SHIELD_WIDTH))/5;
      for(let i=0;i<4;i++){
        const rows=SHIELD_HEIGHT/SHIELD_BLOCK, cols=SHIELD_WIDTH/SHIELD_BLOCK;
        const dmg=Array.from({length:rows},()=>Array(cols).fill(0));
        shields.push({x:gap*(i+1)+i*SHIELD_WIDTH,y:canvas.height-100,width:SHIELD_WIDTH,height:SHIELD_HEIGHT,damage:dmg});
      }
    }

    function drawPlayer(){
      if (player.alive) {
        ctx.fillStyle="#fff";
        ctx.beginPath();
        ctx.moveTo(player.x+player.width/2,player.y); // nose
        ctx.lineTo(player.x,player.y+player.height);
        ctx.lineTo(player.x+player.width,player.y+player.height);
        ctx.closePath(); ctx.fill();
        ctx.fillStyle="#00f";
        ctx.fillRect(player.x+player.width/2-5,player.y+10,10,8);
      } else if (playerExplosionTimer > 0) {
        // Draw explosion animation (simple circles for now)
        const radius = (60 - playerExplosionTimer) * 0.5; // Grow explosion
        ctx.fillStyle = `rgba(255, ${255 - (60 - playerExplosionTimer) * 4}, 0, ${playerExplosionTimer / 60})`; // Orange to red fade
        ctx.beginPath();
        ctx.arc(player.x + player.width / 2, player.y + player.height / 2, radius, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = `rgba(255, 255, 255, ${playerExplosionTimer / 60 * 0.5})`; // White sparks
        for (let i = 0; i < 5; i++) {
          const angle = Math.random() * Math.PI * 2;
          const dist = Math.random() * radius;
          ctx.beginPath();
          ctx.arc(player.x + player.width / 2 + Math.cos(angle) * dist, player.y + player.height / 2 + Math.sin(angle) * dist, 2, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }

    function drawAlien(a){
      ctx.save();
      ctx.translate(a.x,a.y);
      ctx.fillStyle="#0f0";
      // Alien Type 0 (Crab-like)
      if(a.type===0){
        ctx.fillRect(4,0,12,4);
        ctx.fillRect(2,4,16,4);
        ctx.fillRect(0,8,20,4);
        ctx.fillRect(2,12,16,4);
        ctx.fillRect(4,16,4,4);
        ctx.fillRect(12,16,4,4);
      }
      // Alien Type 1 (Squid-like)
      else if(a.type===1){
        ctx.fillRect(6,0,8,4);
        ctx.fillRect(4,4,12,4);
        ctx.fillRect(2,8,16,4);
        ctx.fillRect(0,12,20,4);
        ctx.fillRect(6,16,2,4);
        ctx.fillRect(12,16,2,4);
      }
      // Alien Type 2 (Bug-like)
      else if(a.type===2){
        ctx.fillRect(6,0,8,4);
        ctx.fillRect(4,4,12,4);
        ctx.fillRect(2,8,16,4);
        ctx.fillRect(0,12,20,4);
        ctx.fillRect(4,16,4,4);
        ctx.fillRect(12,16,4,4);
      }
      ctx.restore();
    }

    function drawShields(){
      shields.forEach(s=>{
        for(let r=0;r<s.damage.length;r++){
          for(let c=0;c<s.damage[r].length;c++){
            if(s.damage[r][c]<3){
              const hp=3-s.damage[r][c]; // 3=full, 2=medium, 1=low
              ctx.fillStyle=hp===3?"#0f0":hp===2?"#ffa500":"#f00"; // Green, Orange, Red
              ctx.fillRect(s.x+c*SHIELD_BLOCK,s.y+r*SHIELD_BLOCK,SHIELD_BLOCK,SHIELD_BLOCK);
            }
          }
        }
      });
    }

    function checkCollision(obj1, obj2){
      return obj1.x < obj2.x + obj2.width &&
             obj1.x + obj1.width > obj2.x &&
             obj1.y < obj2.y + obj2.height &&
             obj1.y + obj1.height > obj2.y;
    }

    function update(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(nextWaveTimer>0){
        ctx.fillStyle="#0f0"; ctx.font="bold 40px Arial"; ctx.textAlign="center";
        ctx.fillText(`Next Wave in ${Math.ceil(nextWaveTimer/60)}`,canvas.width/2,canvas.height/2);
        nextWaveTimer--; requestAnimationFrame(update); return;
      }

      // If player is exploding, decrement timer
      if (playerExplosionTimer > 0) {
        drawPlayer(); // Draw explosion
        playerExplosionTimer--;
        if (playerExplosionTimer === 0) {
          gameOver(); // Call game over after explosion animation
          return;
        }
        requestAnimationFrame(update); // Keep animating explosion
        return; // Skip game logic if player is exploding
      }

      if(!gameRunning || gamePaused){ // Pause logic
        if (gamePaused) {
            ctx.fillStyle="#0f0"; ctx.font="bold 40px Arial"; ctx.textAlign="center";
            ctx.fillText("PAUSED",canvas.width/2,canvas.height/2);
        }
        drawPlayer(); // Still draw player and other static elements when paused
        aliens.forEach(drawAlien);
        drawShields();
        bullets.forEach((b,i)=>{ // Draw bullets, but they don't move
            ctx.fillStyle="#0ff";
            ctx.fillRect(b.x,b.y,3,10);
        });
        alienBullets.forEach((b, i) => { // Draw alien bullets, but they don't move
            ctx.fillStyle = "#f00";
            ctx.fillRect(b.x, b.y, 3, 10);
        });

        requestAnimationFrame(update);
        return;
      }

      // Player movement (only if alive and game not paused)
      if (player.alive) {
        player.x+=player.dx;
        if(player.x<0)player.x=0;
        if(player.x+player.width>canvas.width)player.x=canvas.width-player.width;
      }

      // Draw entities
      drawPlayer();
      aliens.forEach(drawAlien);
      drawShields();

      // Player Bullets
      bullets.forEach((b,i)=>{
        b.y-=BULLET_SPEED;
        ctx.fillStyle="#0ff";
        ctx.fillRect(b.x,b.y,3,10);
        if(b.y<0) bullets.splice(i,1);

        // Bullet collision with aliens
        for (let j = 0; j < aliens.length; j++) {
            const a = aliens[j];
            if(checkCollision(b, {x: a.x, y: a.y, width: ALIEN_SIZE, height: ALIEN_SIZE})){
                aliens.splice(j,1);
                bullets.splice(i,1);
                score+=10; updateHUD();
                return; // Exit inner loop as bullet is gone
            }
        }

        // Bullet collision with shields
        for (let sIndex = 0; sIndex < shields.length; sIndex++) {
            const s = shields[sIndex];
            for(let r=0; r<s.damage.length; r++) {
                for(let c=0; c<s.damage[r].length; c++) {
                    if (s.damage[r][c] < 3) { // Only check if block is not destroyed
                        const blockX = s.x + c * SHIELD_BLOCK;
                        const blockY = s.y + r * SHIELD_BLOCK;
                        if (checkCollision(b, {x: blockX, y: blockY, width: SHIELD_BLOCK, height: SHIELD_BLOCK})) {
                            s.damage[r][c]++; // Damage the block
                            bullets.splice(i,1); // Remove bullet
                            return; // Exit both loops
                        }
                    }
                }
            }
        }
      });

      // Alien Bullets
      alienBullets.forEach((b, i) => {
        b.y += ALIEN_BULLET_SPEED;
        ctx.fillStyle = "#f00"; // Red for alien bullets
        ctx.fillRect(b.x, b.y, 3, 10);
        if (b.y > canvas.height) alienBullets.splice(i, 1);

        // Alien bullet collision with player
        if (player.alive && checkCollision(b, player)) {
          alienBullets.splice(i, 1);
          lives--;
          if (soundEnabled) explosionSound.play();
          player.alive = false; // Player is no longer alive
          playerExplosionTimer = 120; // Start explosion animation for 2 seconds (120 frames)
          updateHUD();
          return;
        }

        // Alien bullet collision with shields
        for (let sIndex = 0; sIndex < shields.length; sIndex++) {
            const s = shields[sIndex];
            for(let r=0; r<s.damage.length; r++) {
                for(let c=0; c<s.damage[r].length; c++) {
                    if (s.damage[r][c] < 3) {
                        const blockX = s.x + c * SHIELD_BLOCK;
                        const blockY = s.y + r * SHIELD_BLOCK;
                        if (checkCollision(b, {x: blockX, y: blockY, width: SHIELD_BLOCK, height: SHIELD_BLOCK})) {
                            s.damage[r][c]++;
                            alienBullets.splice(i, 1);
                            return;
                        }
                    }
                }
            }
        }
      });

      // Aliens movement and flying in animation
      let edge=false;
      aliens.forEach(a=>{
        if (a.y < a.targetY) { // Animate flying in
          a.y += 1; // Speed of flying in
        } else {
          a.x+=alienDir*alienSpeed;
          if(a.x<0 || a.x+ALIEN_SIZE>canvas.width) edge=true;
        }
      });
      if(edge){
        alienDir*=-1;
        aliens.forEach(a=>a.y+=10);
      }

      // Alien shooting logic
      alienShootTimer--;
      if (alienShootTimer <= 0 && aliens.length > 0) {
        const shootingAlien = aliens[Math.floor(Math.random() * aliens.length)];
        alienBullets.push({x: shootingAlien.x + ALIEN_SIZE / 2 - 1.5, y: shootingAlien.y + ALIEN_SIZE, width:3, height:10});
        alienShootTimer = 60 - (level * 5); // Shoot more often at higher levels
        if (alienShootTimer < 20) alienShootTimer = 20; // Minimum shoot delay
      }

      // Check bottom collision
      aliens.forEach(a=>{
        if(a.y+ALIEN_SIZE>canvas.height-60){
          if (player.alive) { // Only trigger game over if player hasn't been hit already
            if (soundEnabled) explosionSound.play();
            player.alive = false;
            playerExplosionTimer = 120; // 2-second explosion animation + delay
          }
        }
      });

      // Next level
      if(aliens.length===0){
        level++;
        alienSpeed+=0.2;
        nextWaveTimer=180; // 3 sec countdown
        createAliens(true); // New wave flies in
        createShields(); // Reset shields
      }

      requestAnimationFrame(update);
    }

    function updateHUD(){
      document.getElementById('score').innerText=score;
      document.getElementById('lives').innerText=lives;
      document.getElementById('level').innerText=level;
      document.getElementById('highScore').innerText=highScore;
    }

    function startGame(){
      score=0; lives=3; level=1; alienSpeed=0.5; alienShootTimer = 60;
      initPlayer();
      createAliens(true); // Start with aliens flying in
      createShields();
      bullets = []; // Clear any old bullets
      alienBullets = []; // Clear any old alien bullets
      playerExplosionTimer = 0; // Reset explosion timer
      gamePaused = false; // Ensure game is not paused
      document.getElementById('pauseBtn').innerText = '‚è∏Ô∏è Pause'; // Reset pause button text
      updateHUD(); gameRunning=true;
      document.getElementById('overlay').style.display="none";
    }

    function gameOver(){
      gameRunning=false;
      if(score>highScore){ highScore=score; localStorage.setItem('galacticSiegeHS',highScore); }
      updateHUD();
      const overlay=document.getElementById('overlay');
      overlay.innerHTML=`<div>Game Over</div><button class="overlay-btn" onclick="startGame()">Play Again</button>`;
      overlay.style.display="flex";
    }

    function togglePause() {
        if (!gameRunning) return; // Can't pause if game isn't running

        gamePaused = !gamePaused;
        if (gamePaused) {
            document.getElementById('pauseBtn').innerText = '‚ñ∂Ô∏è Resume';
        } else {
            document.getElementById('pauseBtn').innerText = '‚è∏Ô∏è Pause';
            requestAnimationFrame(update); // Resume the game loop
        }
    }

    function endGame() {
        gameRunning = false;
        gamePaused = false; // Ensure game is not paused
        playerExplosionTimer = 0; // Clear any pending explosion
        score=0; lives=3; level=1; // Reset game state for next start
        updateHUD();
        const overlay=document.getElementById('overlay');
        overlay.innerHTML=`<div>Galactic Siege</div><button class="overlay-btn" id="startBtn">Start Game</button>`;
        document.getElementById('startBtn').onclick=startGame; // Re-assign start game handler
        overlay.style.display="flex";
    }


    document.addEventListener('keydown',e=>{
      if(e.key==="ArrowLeft" && player.alive && !gamePaused) player.dx=-PLAYER_SPEED;
      if(e.key==="ArrowRight" && player.alive && !gamePaused) player.dx=PLAYER_SPEED;
      if(e.key===" " && gameRunning && player.alive && !gamePaused){ // Only allow shooting if game is running and player is alive and not paused
        bullets.push({x:player.x+player.width/2-1.5,y:player.y, width:3, height:10}); // Adjust x for bullet center
        if (soundEnabled) shootSound.play();
      }
    });
    document.addEventListener('keyup',e=>{
      if(e.key==="ArrowLeft"||e.key==="ArrowRight") player.dx=0;
    });

    document.getElementById('startBtn').onclick=startGame;

    document.getElementById('shareBtn').onclick=()=>{navigator.share?navigator.share({title:"Galactic Siege",url:location.href}):navigator.clipboard.writeText(location.href).then(()=>alert("Link copied"));};
    document.getElementById('copyBtn').onclick=()=>{navigator.clipboard.writeText(location.href).then(()=>alert("Link copied"));};
    document.getElementById('soundToggleBtn').onclick=()=>{
      soundEnabled = !soundEnabled;
      document.getElementById('soundToggleBtn').innerText = soundEnabled ? 'üîä Sound On/Off' : 'üîá Sound On/Off';
    };
    document.getElementById('pauseBtn').onclick=togglePause; // Assign pause button handler
    document.getElementById('endGameBtn').onclick=endGame; // Assign end game button handler


    initPlayer(); createShields(); updateHUD(); update();
  </script>
</body>
</html>
