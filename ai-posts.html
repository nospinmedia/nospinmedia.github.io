<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>No Spin Media AI Posts</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Responsive + overflow-safe layout; removes hidden/max-height caps on long posts -->
  <style>
    :root { --header-h: 70px; }
    body { padding-top: var(--header-h); }

    /* Keep the main/side columns from stretching oddly */
    .container {
      display: flex;
      gap: 2rem;
      align-items: flex-start; /* sidebar won't stretch vertically */
      box-sizing: border-box;
      padding: 1rem;
    }
    .main {
      flex: 1 1 auto;
      min-width: 0; /* prevents overflow from long content */
    }
    .sidebar {
      flex: 0 0 320px;   /* fixed, sensible sidebar column */
      max-width: 360px;  /* never wider than this */
      width: 100%;
      box-sizing: border-box;
    }

    /* Post cards should wrap long words and never overflow */
    .post-card { min-width: 0; }
    .post-header h3 {
      margin: 0 0 .25rem 0;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* Collapsible comment panel: JS sets max-height inline to scrollHeight for smooth open/close */
    .comment {
      box-sizing: border-box;
      overflow: hidden;
      max-height: 0;           /* collapsed by default */
      transition: max-height .35s ease;
      white-space: pre-wrap;    /* preserve line breaks from CSV */
      word-break: break-word;
      overflow-wrap: anywhere;
      padding: 0 .25rem;       /* padding applied when open via :not([style*="max-height: 0"]) trick below */
      border-left: 3px solid rgba(0,0,0,0.06);
      margin-top: .5rem;
    }
    /* When open (JS sets max-height), add a little top/bottom padding visually */
    .comment.show { padding: .5rem .25rem; }

    .post-type { font-size: .9rem; opacity: .75; margin-bottom: .25rem; }
    .toggle { cursor: pointer; }

    /* Keep the feedback form neat inside the sidebar */
    .quirky-feedback-form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .quirky-feedback-form textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      box-sizing: border-box;
    }
    .quirky-feedback-form .formStatus {
      margin: 0;
      font-size: 0.95rem;
      min-height: 1.2em; /* avoids layout jump on status show/hide */
    }
    .quirky-feedback-form button {
      align-self: flex-start;
      cursor: pointer;
    }

    /* Footer centered */
    footer { text-align: center; padding: 1.25rem 0; }

    /* Mobile: stack columns */
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .sidebar { flex: 1 1 auto; max-width: 100%; }
    }
      /* Compact sidebar spacing and card layout */
    .sidebar h2, .sidebar h3 { margin-top: 0.5rem; margin-bottom: 0.4rem; }
    .sidebar p { margin: 0.25rem 0; line-height: 1.35; }
    .sidebar section {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .quirky-feedback-form { padding: 0.75rem; gap: 0.5rem; }
    .quirky-feedback-form textarea { min-height: 90px; }
  </style>

  <script>
    let allPosts = [];
    let postId = null;

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function parseDateSafe(dateStr) {
      const parts = dateStr.split('-');
      return new Date(parts[0], parts[1]-1, parts[2]);
    }

    async function loadPosts() {
      postId = getQueryParam('id');
      const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6MD-jJVdU22fsfcC1zu16HdCSeANVZS-Sjxf76iUcu7yCSax43w4UyDfVnQv750z_uSpjA-_pXVB_/pub?output=csv';
      const response = await fetch(sheetURL);
      const text = await response.text();

      const rows = [];
      let current = '', insideQuotes = false, row = [];
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"' && text[i+1] === '"') { current += '"'; i++; continue; }
        if (char === '"') { insideQuotes = !insideQuotes; continue; }
        if (char === ',' && !insideQuotes) { row.push(current); current = ''; continue; }
        if ((char === '\n' || char === '\r') && !insideQuotes) {
          if (current || row.length) { row.push(current); rows.push(row); row = []; current = ''; }
          continue;
        }
        current += char;
      }
      if (current || row.length) { row.push(current); rows.push(row); }

      const data = rows.slice(1);
      allPosts = data.filter(r => r[0].trim() && r[1].trim());

      if (postId) {
        allPosts = allPosts.filter(r => (r[3] || '').trim() === postId);
      }

      allPosts.forEach(r => {
        if (!r[4] || !r[4].trim()) r[4] = 'Story';
      });

      allPosts.sort((a,b) => parseDateSafe(b[0]) - parseDateSafe(a[0]));
      renderPosts();
      populateFilter();
    }

    function renderPosts(filterType = 'all') {
      const container = document.getElementById('posts-container');
      container.innerHTML = '';

      const groups = {};
      allPosts.forEach(r => {
        if (filterType !== 'all' && r[4].trim() !== filterType) return;
        const date = r[0];
        if (!groups[date]) groups[date] = [];
        groups[date].push(r);
      });

      for (const date in groups) {
        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';
        const dateObj = parseDateSafe(date);
        const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        dateGroup.innerHTML = `<div class="date-header">${formattedDate}</div>`;
        groups[date].forEach(r => {
          const post = r[1];
          const comment = (r[2] || '').replace(/— Powered by No Spin Media[\s\S]*/i, '').trim();
          const type = r[4] || 'Story';
          const id = r[3] ? r[3].trim() : '';

          const card = document.createElement('div');
          card.className = 'post-card';
          card.innerHTML = `
            <div class="post-header">
              <h3>${post}</h3>
              <button class="share-btn" onclick="sharePost('${id}')">Share</button>
            </div>
            <div class="post-type">Type: ${type}</div>
            <button class="toggle" onclick="toggleComment(this)">Show ${type}</button>
            <div class="comment"><strong>${type}:</strong>\n${comment}</div>
          `;

          if (postId && id === postId) {
            const commentEl = card.querySelector('.comment');
            commentEl.classList.add('show');
            // Set height to full content so nothing is cut off
            commentEl.style.maxHeight = commentEl.scrollHeight + 'px';
            const toggleBtn = card.querySelector('.toggle');
            toggleBtn.textContent = toggleBtn.textContent.replace('Show', 'Hide');
          }

          dateGroup.appendChild(card);
        });
        container.appendChild(dateGroup);
      }

      // Adjust open panels after first render for correct heights
      requestAnimationFrame(resizeOpenComments);
    }

    function populateFilter() {
      const types = [...new Set(allPosts.map(r => r[4].trim()))];
      const select = document.getElementById('typeFilter');
      select.innerHTML = '<option value="all">All Types</option>';
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        select.appendChild(opt);
      });
    }

    function toggleComment(btn) {
      const commentEl = btn.nextElementSibling;
      const opening = !commentEl.classList.contains('show');
      commentEl.classList.toggle('show');
      if (opening) {
        // Expand smoothly to full height so long content isn't truncated
        commentEl.style.maxHeight = commentEl.scrollHeight + 'px';
        btn.textContent = btn.textContent.replace('Show', 'Hide');
      } else {
        // Collapse
        commentEl.style.maxHeight = '0px';
        btn.textContent = btn.textContent.replace('Hide', 'Show');
      }
    }

    function resizeOpenComments() {
      document.querySelectorAll('.comment.show').forEach(el => {
        el.style.maxHeight = el.scrollHeight + 'px';
      });
    }

    function sharePost(id) {
      const url = `${window.location.origin}${window.location.pathname}?id=${id}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('Share link copied to clipboard!');
      });
    }

    const formSubmitUrl = 'https://script.google.com/macros/s/AKfycbwr26uY61Dip94_QwzyLh1JDSIFdYHJgqL_scKGLdRd9O42VLDBvt2XzkA67tjphJrs/exec';
    
    async function submitQuirkyFeedback(e) {
      e.preventDefault();
      const form = e.target;
      const status = form.querySelector('.formStatus');
      status.textContent = "⏳ Sending to the AI...";

      const data = {
        name: form.querySelector('#quirkyName') ? form.querySelector('#quirkyName').value || "Anonymous" : "Anonymous",
        email: form.querySelector('#quirkyEmail') ? form.querySelector('#quirkyEmail').value : "",
        subject: 'Quirky AI Feedback',
        message: form.querySelector('#quirkyMessage').value
      };

      try {
        const res = await fetch(formSubmitUrl, {
          method: 'POST',
          headers: {'Content-Type': 'text/plain'},
          body: JSON.stringify(data)
        });

        let result = await res.json();
        if (result.status === "success") {
          status.textContent = "✅ The AI has received your thought-spark! Thanks!";
          form.reset();
        } else {
          status.textContent = "❌ Hmm, the AI seems to be napping. Please try again.";
        }
        setTimeout(() => { status.textContent = ""; }, 5000);
      } catch (err) {
        status.textContent = "❌ The connection to the AI is a little glitchy right now.";
        setTimeout(() => { status.textContent = ""; }, 5000);
      }
    }

    window.onload = () => {
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('site-header').innerHTML = html;
          loadPosts();
          
          const hamburger = document.getElementById('hamburger');
          const mobileNav = document.getElementById('mobile-nav');

          if (hamburger && mobileNav) {
            function toggleMobileNav() {
              mobileNav.classList.toggle('open');
              hamburger.classList.toggle('active');
            }
            hamburger.addEventListener('click', toggleMobileNav);
            hamburger.addEventListener('touchstart', function(e) {
              e.preventDefault();
              toggleMobileNav();
            }, { passive: false });

            mobileNav.querySelectorAll('a').forEach(link => {
              link.addEventListener('click', () => {
                mobileNav.classList.remove('open');
                hamburger.classList.remove('active');
              });
            });

            window.addEventListener('resize', function() {
              if (window.innerWidth > 768) {
                mobileNav.classList.remove('open');
                hamburger.classList.remove('active');
              }
              // Keep open comments sized correctly on viewport changes
              resizeOpenComments();
            });
          }
          
          const quirkyForm = document.getElementById('quirkyFeedbackForm');
          if (quirkyForm) {
            quirkyForm.addEventListener('submit', submitQuirkyFeedback);
          }
        });
    }
  </script>
</head>
<body>

  <div id="site-header"></div>

  <div class="container">
    <div class="main">
      <h1>AI Generated Posts</h1>
      <div class="filter-bar">
        <label for="typeFilter"><strong>Filter by Type:</strong></label>
        <select id="typeFilter" onchange="renderPosts(this.value)"></select>
      </div>
      <div id="posts-container"></div>
    </div>

    <div class="sidebar">
      <section>
        <h2>Support No Spin Media 💙</h2>
        <p>Like the AI stories and daily posts? You can help keep them coming:</p>
        <p><strong>Venmo:</strong><br/>
          <a href="https://venmo.com/NoSpinMedia" target="_blank">@NoSpinMedia</a>
        </p>
      </section>

      <section>
        <h2>Follow Us</h2>
        <p>📘 <a href="https://facebook.com/NoSpinNewsAI" target="_blank">facebook.com/NoSpinNewsAI</a></p>
      </section>

      <section>
        <h2>Contact</h2>
        <p>📨 nospinmedia.ai@gmail.com</p>
      </section>

      <section>
        <h2>Suggest a post idea ✍️</h2>
        <p>Got a topic, fun fact, riddle, or short story prompt you want to see?</p>
        <form id="quirkyFeedbackForm" class="quirky-feedback-form">
          <textarea id="quirkyMessage" name="message" rows="4" placeholder="Share a post idea or prompt for the AI posts (stories, fun facts, riddles)…"></textarea>
          <p class="formStatus"></p>
          <button type="submit">Send idea</button>
        </form>
      </section>
    </div>
  </div>

  <footer>
    © 2025 No Spin Media. Independent. Ad-free. Truth-focused.
  </footer>

</body>
</html>
