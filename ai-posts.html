async function loadPosts() {
  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6MD-jJVdU22fsfcC1zu16HdCSeANVZS-Sjxf76iUcu7yCSax43w4UyDfVnQv750z_uSpjA-_pXVB_/pub?output=csv';
  const response = await fetch(sheetURL);
  const text = await response.text();

  const rows = [];
  let current = '', insideQuotes = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (char === '"' && text[i+1] === '"') { current += '"'; i++; continue; }
    if (char === '"') { insideQuotes = !insideQuotes; continue; }
    if (char === ',' && !insideQuotes) { row.push(current); current = ''; continue; }
    if ((char === '\n' || char === '\r') && !insideQuotes) {
      if (current || row.length) { row.push(current); rows.push(row); row = []; current = ''; }
      continue;
    }
    current += char;
  }
  if (current || row.length) { row.push(current); rows.push(row); }

  const data = rows.slice(1);
  allPosts = data.filter(r => r[0].trim() && r[1].trim());

  // ✅ Default Type to "Story" if missing
  allPosts.forEach(r => {
    if (!r[4] || !r[4].trim()) r[4] = 'Story';
  });

  allPosts.sort((a,b) => new Date(b[0]) - new Date(a[0]));

  renderPosts();
  populateFilter();
}

function populateFilter() {
  const types = [...new Set(allPosts.map(r => r[4].trim()))];
  const select = document.getElementById('typeFilter');
  // ✅ Add proper <option> markup
  select.innerHTML = '<option value="all">All Types</option>'; 

  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    select.appendChild(opt);
  });
}
